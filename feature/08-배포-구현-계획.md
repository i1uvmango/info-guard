# 배포 구현 계획

## 🎯 **배포 구현 개요**
Info-Guard 프로젝트의 배포는 Docker 컨테이너화, CI/CD 파이프라인, 그리고 프로덕션 환경 설정을 포함합니다. 개발 환경에서 프로덕션 환경까지 원활한 배포를 위한 자동화 시스템을 구축합니다.

## 🏗️ **배포 아키텍처**

### 1. 전체 배포 구조
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   GitHub Repo   │    │  GitHub Actions │    │   Docker Hub    │
│   (Source Code) │───►│   (CI/CD)       │───►│   (Registry)    │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Local Dev     │    │   Staging       │    │   Production    │
│   Environment   │    │   Environment   │    │   Environment   │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 2. 환경별 구성
- **개발 환경 (Development)**: 로컬 개발용
- **스테이징 환경 (Staging)**: 테스트 및 검증용
- **프로덕션 환경 (Production)**: 실제 서비스 운영용

## 🐳 **Docker 컨테이너화**

### 1. Python 서버 Dockerfile
```dockerfile
# 구현 위치: src/python-server/Dockerfile

FROM python:3.11-slim

# 작업 디렉토리 설정
WORKDIR /app

# 시스템 패키지 업데이트 및 필요한 패키지 설치
RUN apt-get update && apt-get install -y \
    gcc \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# Python 의존성 파일 복사 및 설치
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# 애플리케이션 코드 복사
COPY . .

# 포트 노출
EXPOSE 8000

# 헬스체크 추가
HEALTHCHECK --interval=30s --timeout=30s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8000/api/v1/health || exit 1

# 애플리케이션 실행
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000"]
```

### 2. Node.js 서버 Dockerfile
```dockerfile
# 구현 위치: src/nodejs-server/Dockerfile

FROM node:18-alpine

# 작업 디렉토리 설정
WORKDIR /app

# package.json 및 package-lock.json 복사
COPY package*.json ./

# 의존성 설치
RUN npm ci --only=production

# 애플리케이션 코드 복사
COPY . .

# 포트 노출
EXPOSE 3000

# 헬스체크 추가
HEALTHCHECK --interval=30s --timeout=30s --start-period=5s --retries=3 \
    CMD wget --no-verbose --tries=1 --spider http://localhost:3000/api/v1/health || exit 1

# 애플리케이션 실행
CMD ["npm", "start"]
```

### 3. Docker Compose 설정
```yaml
# 구현 위치: docker-compose.yml

version: '3.8'

services:
  # PostgreSQL 데이터베이스
  postgres:
    image: postgres:15-alpine
    container_name: infoguard-postgres
    environment:
      POSTGRES_DB: infoguard
      POSTGRES_USER: infoguard_user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/init:/docker-entrypoint-initdb.d
    ports:
      - "5432:5432"
    networks:
      - infoguard-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U infoguard_user -d infoguard"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Redis 캐시
  redis:
    image: redis:7-alpine
    container_name: infoguard-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - infoguard-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Python AI 서버
  python-server:
    build:
      context: ./src/python-server
      dockerfile: Dockerfile
    container_name: infoguard-python-server
    environment:
      - DATABASE_URL=postgresql://infoguard_user:${POSTGRES_PASSWORD}@postgres:5432/infoguard
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=${JWT_SECRET}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - infoguard-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Node.js 백엔드 서버
  nodejs-server:
    build:
      context: ./src/nodejs-server
      dockerfile: Dockerfile
    container_name: infoguard-nodejs-server
    environment:
      - DATABASE_URL=postgresql://infoguard_user:${POSTGRES_PASSWORD}@postgres:5432/infoguard
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=${JWT_SECRET}
      - PYTHON_SERVER_URL=http://python-server:8000
    ports:
      - "3000:3000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      python-server:
        condition: service_healthy
    networks:
      - infoguard-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/v1/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Nginx 리버스 프록시
  nginx:
    image: nginx:alpine
    container_name: infoguard-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
    depends_on:
      - python-server
      - nodejs-server
    networks:
      - infoguard-network

volumes:
  postgres_data:
  redis_data:

networks:
  infoguard-network:
    driver: bridge
```

## 🚀 **CI/CD 파이프라인**

### 1. GitHub Actions 워크플로우
```yaml
# 구현 위치: .github/workflows/deploy.yml

name: Deploy to Production

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # 테스트 및 빌드
  test-and-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install Python dependencies
      run: |
        cd src/python-server
        pip install -r requirements-dev.txt
    
    - name: Run Python tests
      run: |
        cd src/python-server
        python -m pytest tests/ -v --cov=app
    
    - name: Install Node.js dependencies
      run: |
        cd src/nodejs-server
        npm ci
    
    - name: Run Node.js tests
      run: |
        cd src/nodejs-server
        npm test
    
    - name: Build Docker images
      run: |
        docker build -t infoguard-python:latest src/python-server/
        docker build -t infoguard-nodejs:latest src/nodejs-server/
    
    - name: Run integration tests
      run: |
        docker-compose -f docker-compose.test.yml up --build --abort-on-container-exit

  # 스테이징 배포
  deploy-staging:
    needs: test-and-build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Deploy to staging
      run: |
        echo "스테이징 환경에 배포 중..."
        # 스테이징 배포 스크립트 실행

  # 프로덕션 배포
  deploy-production:
    needs: [test-and-build, deploy-staging]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
    - name: Deploy to production
      run: |
        echo "프로덕션 환경에 배포 중..."
        # 프로덕션 배포 스크립트 실행
```

### 2. 배포 스크립트
```bash
#!/bin/bash
# 구현 위치: scripts/deploy.sh

set -e

ENVIRONMENT=$1
VERSION=$2

if [ -z "$ENVIRONMENT" ] || [ -z "$VERSION" ]; then
    echo "사용법: ./deploy.sh <environment> <version>"
    echo "예시: ./deploy.sh production v1.0.0"
    exit 1
fi

echo "🚀 $ENVIRONMENT 환경에 $VERSION 버전을 배포합니다..."

# 환경별 설정 파일 로드
source .env.$ENVIRONMENT

# Docker 이미지 태그
docker tag infoguard-python:latest infoguard-python:$VERSION
docker tag infoguard-nodejs:latest infoguard-nodejs:$VERSION

# 기존 컨테이너 중지 및 제거
docker-compose -f docker-compose.$ENVIRONMENT.yml down

# 새 컨테이너 시작
docker-compose -f docker-compose.$ENVIRONMENT.yml up -d

# 헬스체크 대기
echo "서비스 헬스체크 중..."
sleep 30

# 서비스 상태 확인
if docker-compose -f docker-compose.$ENVIRONMENT.yml ps | grep -q "Up"; then
    echo "✅ $ENVIRONMENT 환경 배포가 완료되었습니다!"
else
    echo "❌ 배포 중 오류가 발생했습니다."
    exit 1
fi
```

## 🌐 **프로덕션 환경 설정**

### 1. Nginx 설정
```nginx
# 구현 위치: nginx/nginx.conf

events {
    worker_connections 1024;
}

http {
    upstream python_backend {
        server python-server:8000;
    }
    
    upstream nodejs_backend {
        server nodejs-server:3000;
    }
    
    # Gzip 압축
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;
    
    # 보안 헤더
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    server {
        listen 80;
        server_name infoguard.example.com;
        
        # HTTP를 HTTPS로 리다이렉트
        return 301 https://$server_name$request_uri;
    }
    
    server {
        listen 443 ssl http2;
        server_name infoguard.example.com;
        
        # SSL 인증서 설정
        ssl_certificate /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384;
        ssl_prefer_server_ciphers off;
        
        # Python AI 서버 API
        location /api/v1/analysis/ {
            proxy_pass http://python_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # Node.js 백엔드 API
        location /api/v1/ {
            proxy_pass http://nodejs_backend;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # WebSocket 연결
        location /ws/ {
            proxy_pass http://python_backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # 정적 파일 서빙
        location /static/ {
            alias /var/www/static/;
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }
}
```

### 2. 환경 변수 설정
```bash
# 구현 위치: .env.production

# 데이터베이스 설정
POSTGRES_PASSWORD=your_secure_password_here
DATABASE_URL=postgresql://infoguard_user:your_secure_password_here@localhost:5432/infoguard

# Redis 설정
REDIS_URL=redis://localhost:6379

# JWT 설정
JWT_SECRET=your_jwt_secret_here

# API 키
OPENAI_API_KEY=your_openai_api_key_here
YOUTUBE_API_KEY=your_youtube_api_key_here

# 서버 설정
NODE_ENV=production
PYTHON_ENV=production
PORT=3000
PYTHON_PORT=8000

# 로깅 설정
LOG_LEVEL=INFO
LOG_FILE=/var/log/infoguard/app.log

# 보안 설정
CORS_ORIGINS=https://infoguard.example.com
RATE_LIMIT_WINDOW=900000
RATE_LIMIT_MAX=100
```

## 📊 **모니터링 및 로깅**

### 1. Prometheus 메트릭 수집
```yaml
# 구현 위치: monitoring/prometheus.yml

global:
  scrape_interval: 15s

scrape_configs:
  - job_name: 'python-server'
    static_configs:
      - targets: ['python-server:8000']
    metrics_path: '/metrics'
    
  - job_name: 'nodejs-server'
    static_configs:
      - targets: ['nodejs-server:3000']
    metrics_path: '/metrics'
    
  - job_name: 'postgres'
    static_configs:
      - targets: ['postgres:5432']
    
  - job_name: 'redis'
    static_configs:
      - targets: ['redis:6379']
```

### 2. Grafana 대시보드
```json
{
  "dashboard": {
    "title": "Info-Guard 시스템 모니터링",
    "panels": [
      {
        "title": "API 응답 시간",
        "type": "graph",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))"
          }
        ]
      },
      {
        "title": "요청 수",
        "type": "stat",
        "targets": [
          {
            "expr": "rate(http_requests_total[5m])"
          }
        ]
      }
    ]
  }
}
```

## 🔒 **보안 설정**

### 1. 방화벽 설정
```bash
#!/bin/bash
# 구현 위치: scripts/setup-firewall.sh

# UFW 방화벽 활성화
ufw --force enable

# 기본 정책 설정
ufw default deny incoming
ufw default allow outgoing

# SSH 접속 허용
ufw allow ssh

# HTTP/HTTPS 포트 허용
ufw allow 80
ufw allow 443

# 데이터베이스 포트는 로컬에서만 접근 허용
ufw allow from 127.0.0.1 to any port 5432
ufw allow from 127.0.0.1 to any port 6379

# 방화벽 상태 확인
ufw status verbose
```

### 2. SSL 인증서 자동 갱신
```bash
#!/bin/bash
# 구현 위치: scripts/renew-ssl.sh

# Let's Encrypt 인증서 갱신
certbot renew --quiet

# Nginx 재시작
docker-compose restart nginx

echo "SSL 인증서 갱신 완료: $(date)"
```

## 🎯 **구현 완료 체크리스트**

- [ ] Docker 컨테이너화
- [ ] Docker Compose 설정
- [ ] 기본 CI/CD 파이프라인
- [ ] 환경별 설정 파일

- [ ] 프로덕션 환경 배포
- [ ] 모니터링 시스템 구축

- [ ] 자동 스케일링 설정
- [ ] 백업 및 복구 시스템
- [ ] 로드 밸런서 설정
- [ ] CDN 설정

